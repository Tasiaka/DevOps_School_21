## Part 1. Настройка gitlab-runner

##### Подними виртуальную машину Ubuntu Server 22.04 LTS.
##### Будь готов, что в конце проекта нужно будет сохранить дамп образа виртуальной машины.
##### Скачай и установи на виртуальную машину gitlab-runner.

По умолчанию, Runner не устанавливается вместе с GitLab. Для его установки необходимо сначала настроить репозиторий — наши действия зависят от используемой системы.

система на базе deb-пакетов (Debian / Ubuntu):

    curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash

Установка
После настройки репозитория, выполняем установку. Команда также зависит от типа операционной системы.

для Debian / Ubuntu (системы на основе deb-пакетов):

    apt-get install gitlab-runner

![Alt text](<pic/1.png>)

![Alt text](<pic/2.png>)

##### Запусти gitlab-runner и зарегистрируй его для использования в текущем проекте (DO6_CICD). Для регистрации понадобятся URL и токен, которые можно получить на страничке задания на платформе.

    sudo gitlab-runner start
    sudo systemctl enable --now gitlab-runner

![Alt text](<pic/5.png>)

![Alt text](<pic/7.png>)

## Part 2. Сборка

##### Напиши этап для CI по сборке приложений из проекта C2_SimpleBashUtils.
##### В файле gitlab-ci.yml добавь этап запуска сборки через мейк файл из проекта C2.
##### Файлы, полученные после сборки (артефакты), сохрани в произвольную директорию со сроком хранения 30 дней.

![Alt text](<pic/8.png>)

Перед запуском раннера необходимо скачать на виртуалку make, git 

## Part 3. Тест кодстайла

##### Напиши этап для CI, который запускает скрипт кодстайла (clang-format).
##### Если кодстайл не прошел, то «зафейли» пайплайн.
##### В пайплайне отобрази вывод утилиты clang-format.

![Alt text](<pic/9.png>)

перед запуском необходимо установить clang-format на виртуалку

## Part 4. Интеграционные тесты

##### Напиши этап для CI, который запускает твои интеграционные тесты из того же проекта.
##### Запусти этот этап автоматически только при условии, если сборка и тест кодстайла прошли успешно.
##### Если тесты не прошли, то «зафейли» пайплайн.
##### В пайплайне отобрази вывод, что интеграционные тесты успешно прошли / провалились.

![Alt text](<pic/10.png>)

![Alt text](<pic/11.png>)


## Part 5. Этап деплоя

##### Подними вторую виртуальную машину Ubuntu Server 22.04 LTS.
##### Напиши этап для CD, который «разворачивает» проект на другой виртуальной машине.
##### Запусти этот этап вручную при условии, что все предыдущие этапы прошли успешно.
##### Напиши bash-скрипт, который при помощи ssh и scp копирует файлы, полученные после сборки (артефакты), в директорию /usr/local/bin второй виртуальной машины.
##### Тут тебе могут помочь знания, полученные в проекте DO2_LinuxNetwork.
##### Будь готов объяснить по скрипту, как происходит перенос.
##### В файле gitlab-ci.yml добавь этап запуска написанного скрипта. В случае ошибки «зафейли» пайплайн. В результате ты должен получить готовые к работе приложения из проекта C2_SimpleBashUtils (s21_cat и s21_grep) на второй виртуальной машине.

меняю ip адреса машин в 

    sudo vim /etc/netplan/00-installer-config.yaml

![Alt text](<pic/13.png>)

    при sudo netplan apply вылезает ошибка

    $ sudo apt-get install openvswitch-switch-dpdk

меняю настройки сети

![Alt text](<pic/12.png>)

качаю для пинга

    sudo apt-get install iputils-ping

![Alt text](<pic/14.png>)

Меняю пользователя на gitlab-runner

    sudo su gitlab-runner

![Alt text](<pic/18.png>)

Генерю ключ + добавляю его на вторую машину

    ssh-keygen
    ssh-copy-id cd@10.0.2.14

![Alt text](<pic/16.png>)


    $ scp опции пользователь1@хост1:файл пользователь2@хост2:файл

Опции утилиты больше касаются протокола SSH и настраивают общее ее поведение. Дальше следует адрес первого и второго файла. Каждый из них может быть расположен как на локальной, так и на удаленной машине. А теперь рассмотрим основные опции, которые могут нам понадобиться:

    -1 - использовать протокол SSH1;
    -2 - использовать протокол SSH2;
    -B - пакетный режим для передачи нескольких файлов;
    -C - включить сжатие;
    -l - установить ограничение скорости в кбит/сек;
    -o - задать нужную опцию SSH;
    -p - сохранять время модификации;
    -r - рекурсивное копирование директорий;
    -v - более подробный режим.

скрипт 
![Alt text](<pic/17.png>)

## Part 6. Дополнительно. Уведомления

##### Настрой уведомления о успешном/неуспешном выполнении пайплайна через бота с именем «[твой nickname] DO6 CI/CD» в Telegram.
##### Текст уведомления должен содержать информацию об успешности прохождения как этапа CI, так и этапа CD.
##### В остальном текст уведомления может быть произвольным.

Ищем @BotFather в телеграмме и создаём своего бота

Узнать id бота можно перейдя по этой ссылке(предварительно нужно что-то написать боту)

    https://api.telegram.org/bot<Токен вашего бота>/getUpdates

![Alt text](<pic/19.png>)

![Alt text](<pic/20.png>)

В скрипте "tg.sh" c помощью curl отправляется POST-запрос на указанный URL для отправки сообщения в чат Telegram.

    -d, --data

(HTTP) Отправляет указанные данные в запросе POST на HTTP-сервер способом, который имитирует, как если бы пользователь заполнил форму в формате HTML и нажал кнопку отправки. Обратите внимание, что данные отправляются точно так, как указано, без дополнительной обработки (с отсечением всех новых строк). Ожидается, что данные будут "закодированы в URL". Это заставляет curl передавать данные на сервер, используя тип содержимого application/x-www-form-urlencoded. Сравните с -F/--form. Если эта опция используется более одного раза в одной и той же командной строке, указанные фрагменты данных объединяются разделяющим символом "&". Таким образом, использование '-d name=daniel -d skill=lousy' сгенерирует фрагмент POST, который выглядит как 'name= daniel&skill=lousy'.

Если вы начинаете данные с символа "@", остальное должно быть именем файла для чтения данных, или "-" (тире), если вы хотите, чтобы curl считывал данные из stdin. Содержимое файла уже должно быть закодировано по URL. Также может быть указано несколько файлов. Таким образом, отправка данных из файла с именем 'foobar' будет выполняться с помощью "--data @foo-bar".

-d/--data совпадает с --data-ascii. Чтобы отправлять данные исключительно в двоичном виде, используйте опцию --data-binary. Для URL-кодирования значения поля формы вы можете использовать --data-urlencode.

Если эта опция используется несколько раз, данные будут добавлены в те, которые следуют за первой.

    -s, --silent	

Беззвучный режим. Не показывает индикатор выполнения или сообщения об ошибках. Отключает curl. Она по-прежнему выводит запрашиваемые вами данные, возможно, даже в терминал / стандартный вывод, если вы не перенаправите их.

    -m, --max-time <seconds>	

Maximum time in seconds you allow the whole operation to take. This is useful for preventing your batch jobs from hanging for hours due to slow networks or links going down. See also the --connect-timeout option.

If this option is used several times, the last one will be used.